<!DOCTYPE html>
<html>
  <head>
    <title>ComPlay: Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link href = "css/navbar.css" rel = "stylesheet">
    <!-- Button CSS -->
    <link href = "css/bootstrap-social.css" rel = "stylesheet">

    <link rel="stylesheet" type="text/css" href="css/complay.css" />
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <script src="https://maps.googleapis.com/maps/api/js?signed_in=false&callback=initMap"
        async >
    </script>
    <script src="complay.js"></script>
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 92.3%;
		width: 100%
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container topnav">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand topnav" href="#"><strong>ComPlay</strong></a>
            </div>
            <!-- Collect the nav links, forms, and other content for toggling -->

            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <form id="logoutform" class = "navbar-form navbar-right" method="post" action="logout.php" >
                    <div class="form-group">
                        <label id="welcome"></label>
                    </div>
                    <div class="form-group">
                    </div>
                    <button type="submit" class="btn btn-default" style="margin-left: 15px">Logout</button>
                </form>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>
    <div id="map"></div>
    <script>
// Note: This example requires that you consent to location sharing when
// prompted by your browser. If you see the error "The Geolocation service
// failed.", it means you probably did not give permission for the browser to
// locate you.
var map;
var sessionData = getSessionData();
var mappoints;
var markers = [];
function initMap() {
  var kekmap = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 37.6, lng: -95.665},
    zoom: 6
  });
  map=kekmap;
  var infoWindow = new google.maps.InfoWindow({map: map});
  setInterval(asyncGetLocationData, 3000);
  // Try HTML5 geolocation.
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = {
        lat: position.coords.latitude,
        lng: position.coords.longitude
      };

      infoWindow.setPosition(pos);
      infoWindow.setContent('Location found.');
      map.setCenter(pos);
      asyncGetLocationData();
    }, function() {
      handleLocationError(true, infoWindow, map.getCenter());
    });
  } else {
    // Browser doesn't support Geolocation
    handleLocationError(false, infoWindow, map.getCenter());
  }
}

function handleLocationError(browserHasGeolocation, infoWindow, pos) {
  infoWindow.setPosition(pos);
  infoWindow.setContent(browserHasGeolocation ?
                        'Error: The Geolocation service failed.' :
                        'Error: Your browser doesn\'t support geolocation.');
}

function asyncGetLocationData() {
    var xmlhttp;
    if (window.XMLHttpRequest) {
        // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
    } else {
        // code for IE6, IE5
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    var maxlat = map.getBounds().getNorthEast().lat();
    var maxlng = map.getBounds().getNorthEast().lng();
    var minlat = map.getBounds().getSouthWest().lat();
    var minlng = map.getBounds().getSouthWest().lng();
    console.log(minlat+", "+maxlat+" : "+minlng+", "+maxlng);
    xmlhttp.onreadystatechange=function() {
        if (xmlhttp.readyState==4 && xmlhttp.status==200) {
            mappoints = JSON.parse(xmlhttp.responseText);
            renderMapPoints(mappoints);
        }
    };
    xmlhttp.open("POST", "get_location_data.php", true);
    xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xmlhttp.send("maxlat="+maxlat+"&maxlong="+maxlng+"&minlat="+minlat+"&minlong="+minlng);
}

function renderMapPoints(mappoints){
    var mark;
    var xmlhttp;
    if (window.XMLHttpRequest) {
        // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
    } else {
        // code for IE6, IE5
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    j = markers.length;
    for(var i = 0; i<mappoints.length; i++){
        if(mappoints[i].type === "group") {
            xmlhttp.open("GET", "get_group_data.php?groupid=" + mappoints[i].id, false);
            xmlhttp.send();
            var group = JSON.parse(xmlhttp.responseText);
            mark = new google.maps.Marker({
                position: {lat: parseFloat(mappoints[i].lat), lng: parseFloat(mappoints[i].lng)},
                map: map,
                title: group.name+": "+group.game,
                draggable: false
            });
            xmlhttp.open("GET", "get_user_data.php?userid=" + group.ownerid, false);
            xmlhttp.send();
            var skilllevel;
            switch(group.skill){
                case 0:
                case 1:
                case 2:
                case 3: skilllevel="beginners"; break;
                case 4:
                case 5:
                case 6: skilllevel="intermediate participants"; break;
                case 7:
                case 8:
                case 9: skilllevel="experienced participants"; break;
                default: skilllevel="anyone and everyone!"; break;
            }
            var user = JSON.parse(xmlhttp.responseText);
            var contentstring = "<h2>"+group.name+"</h2><br/><h4>An event for: "+group.game+"</h4><br/>" +
                            "<p>Created by "+user.username+". For "+skilllevel+". Expires: "+(group.expirytime || "Never")+".</p>";
            var tooltip = new google.maps.InfoWindow({content: contentstring});
            mark.addListener('click', function(){
                tooltip.open(map, mark);
            });
            map.addListener('click', function(){
                tooltip.close();
            });
        } else if(mappoints[i].type === "user"){
            xmlhttp.open("GET", "get_user_data.php?userid=" + mappoints[i].id, false);
            xmlhttp.send();
            var user = JSON.parse(xmlhttp.responseText);
            mark = new google.maps.Marker({
                position: {lat: parseFloat(mappoints[i].lat), lng: parseFloat(mappoints[i].lng)},
                map: map,
                title: user.name,
                draggable: false
            });
            var contentstring = "<h2>"+user.username+"</h2><br/><h4>An event for: "+group.game+"</h4><br/>" +
                    "<p>Created by "+user.username+".</p>"
            var tooltip = new google.maps.InfoWindow({content: contentstring});
            mark.addListener('click', function(){
                tooltip.open(map, mark);
            });
            map.addListener('click', function(){
                tooltip.close();
            });
        }
        markers.push(mark);
    }
    for(var i = 0; i<j; i++) {
        markers[i].setMap(null);
    }
    markers = markers.splice(0, j);

}

function getSessionData() {
    var xmlhttp;
    if (window.XMLHttpRequest) {
        // code for IE7+, Firefox, Chrome, Opera, Safari
        xmlhttp = new XMLHttpRequest();
    } else {
        // code for IE6, IE5
        xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
    }
    xmlhttp.open("POST", "get_session_data.php", false);
    xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    xmlhttp.send();
    var $_SESSION = JSON.parse(xmlhttp.responseText);
    if($_SESSION.hasOwnProperty("loggedin") && $_SESSION.hasOwnProperty("name") && $_SESSION.loggedin === true) {
        document.getElementById("welcome").innerHTML="Welcome, "+$_SESSION.name;
    }
    else {
        window.location = "signin.html";
    }
    return $_SESSION;
}
    </script>
  <!-- <script src="https://maps.googleapis.com/maps/api/js?signed_in=false&callback=initMap"
        async defer>
    </script> -->
  </body>
</html>
